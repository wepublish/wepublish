import {css} from '@emotion/react'
import {action} from '@storybook/addon-actions'
import {StoryObj} from '@storybook/react'
import {Challenge, ChallengeDocument, RegisterDocument} from '@wepublish/website/api'
import {RegistrationFormContainer} from './registration-form-container'
import * as registrationFormStories from './registration-form.stories'
import {ApolloError} from '@apollo/client'
import {useUser} from '../session.context'
import {waitFor, within} from '@storybook/testing-library'

export default {
  title: 'Container/Registration Form',
  component: RegistrationFormContainer
}

const challenge = {
  challengeID:
    'MTY4NjY2MzEyMDU0MjtGOHpxUEhscldLL0I5a0t4aVdtaTQrMDRob21iRG5sMm5yWEJob0YybUFjPTs0NzI1',
  challenge:
    '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0,0,200,200"><rect width="100%" height="100%" fill="#ffffff"/><path d="M12 170 C89 84,113 69,184 148" stroke="#56e57a" fill="none"/><path d="M8 92 C120 32,84 73,183 109" stroke="#68cced" fill="none"/><path fill="#da9e62" d="M120.01 97.20L120.07 93.78L143.99 93.68L144.08 97.24L119.94 97.12ZM120.02 109.14L120.06 105.70L144.10 105.72L144.06 109.15L119.92 109.03Z"/><path d="M2 185 C113 113,88 106,196 22" stroke="#914ad8" fill="none"/><path fill="#9b7ef0" d="M91.51 110.32L91.51 110.32L91.53 110.34Q91.62 111.94 92.20 113.17L92.07 113.03L92.16 113.13Q92.62 114.23 93.66 115.15L93.64 115.14L93.72 115.21Q94.86 116.25 96.26 116.75L96.07 116.56L96.24 116.73Q97.54 117.13 99.17 117.13L99.19 117.16L99.12 117.08Q102.42 117.25 104.35 115.52L104.25 115.41L104.24 115.41Q106.29 113.79 106.29 110.99L106.10 110.80L106.15 110.84Q106.10 109.06 105.32 107.83L105.35 107.86L105.37 107.88Q104.69 106.76 103.35 105.83L103.37 105.85L103.35 105.83Q101.98 104.88 100.22 104.13L100.11 104.02L100.22 104.13Q98.35 103.27 96.44 102.48L96.57 102.61L96.50 102.54Q94.34 103.97 92.92 105.90L92.88 105.86L93.05 106.03Q91.43 107.77 91.43 110.24ZM101.55 100.37L101.59 100.41L101.67 100.48Q103.33 98.73 104.31 96.93L104.46 97.08L104.42 97.05Q105.28 95.14 105.28 93.18L105.41 93.31L105.40 93.30Q105.44 90.65 103.81 88.83L103.81 88.82L103.64 88.65Q102.02 86.84 99.05 86.84L99.04 86.83L99.05 86.83Q96.59 86.89 94.97 88.46L95.07 88.56L95.04 88.53Q93.45 90.14 93.45 92.77L93.34 92.66L93.42 92.74Q93.40 94.35 94.07 95.49L94.05 95.47L94.02 95.44Q94.70 96.60 95.85 97.49L95.94 97.58L95.85 97.50Q97.06 98.45 98.54 99.15L98.41 99.02L98.59 99.20Q99.97 99.80 101.60 100.41ZM87.31 110.71L87.32 110.72L87.33 110.73Q87.29 108.95 87.88 107.47L88.04 107.64L87.94 107.53Q88.58 106.10 89.50 104.89L89.42 104.81L89.45 104.85Q90.49 103.76 91.70 102.83L91.66 102.80L91.51 102.65Q92.73 101.74 94.02 101.07L94.16 101.21L94.03 100.85L94.06 100.89Q92.22 99.60 90.71 97.61L90.57 97.48L90.57 97.47Q89.20 95.63 89.20 92.77L89.20 92.77L89.07 92.65Q89.07 90.58 89.86 88.90L89.83 88.87L89.81 88.85Q90.70 87.28 92.05 86.08L91.96 85.99L92.00 86.03Q93.43 84.91 95.28 84.24L95.21 84.17L95.15 84.11Q97.00 83.44 99.18 83.44L99.28 83.54L99.31 83.57Q101.70 83.60 103.55 84.30L103.40 84.16L103.39 84.15Q105.26 84.87 106.58 86.13L106.57 86.12L106.68 86.23Q107.89 87.39 108.59 89.15L108.57 89.13L108.56 89.12Q109.37 90.99 109.37 93.06L109.37 93.07L109.30 93.00Q109.30 94.40 108.83 95.69L108.89 95.75L108.86 95.72Q108.40 97.02 107.70 98.14L107.65 98.10L107.60 98.04Q107.06 99.32 106.19 100.22L106.08 100.11L106.20 100.23Q105.33 101.12 104.49 101.74L104.42 101.67L104.33 101.80L104.35 101.82Q105.53 102.50 106.65 103.37L106.75 103.46L106.67 103.39Q107.74 104.21 108.61 105.30L108.77 105.46L108.76 105.45Q109.55 106.46 110.08 107.86L110.10 107.88L109.99 107.77Q110.68 109.33 110.68 111.12L110.63 111.07L110.56 111.00Q110.58 113.04 109.74 114.77L109.83 114.87L109.74 114.77Q108.94 116.55 107.43 117.84L107.35 117.75L107.52 117.93Q105.84 119.05 103.71 119.78L103.75 119.81L103.70 119.77Q101.60 120.52 99.02 120.52L99.16 120.66L99.12 120.61Q96.53 120.55 94.38 119.82L94.45 119.89L94.31 119.76Q92.19 119.06 90.65 117.74L90.75 117.85L90.70 117.79Q89.24 116.56 88.34 114.77L88.23 114.66L88.22 114.65Q87.44 112.96 87.44 110.84Z"/><path fill="#89ef89" d="M32.28 102.58L32.17 102.48L32.16 102.46Q33.96 102.53 35.95 101.44L35.87 101.36L35.98 101.47Q37.92 100.33 39.71 97.75L39.76 97.80L39.81 97.85Q39.26 92.48 37.24 89.80L37.32 89.87L37.37 89.93Q35.33 87.21 31.92 87.21L31.87 87.17L31.80 87.10Q30.66 87.25 29.51 87.81L29.46 87.75L29.46 87.75Q28.30 88.30 27.46 89.33L27.39 89.26L27.44 89.32Q26.59 90.34 26.12 91.80L26.16 91.84L26.21 91.89Q25.64 93.26 25.64 95.00L25.73 95.09L25.56 94.91Q25.61 98.49 27.23 100.50L27.21 100.48L27.22 100.49Q28.87 102.53 32.23 102.53ZM21.96 116.85L24.44 113.84L24.59 113.99Q25.66 115.22 27.20 116.01L27.17 115.99L27.12 115.93Q28.62 116.67 30.30 116.67L30.33 116.71L30.49 116.87Q32.28 116.75 33.96 115.97L34.07 116.08L33.97 115.98Q35.61 115.15 36.90 113.33L36.85 113.28L36.95 113.39Q38.21 111.54 39.00 108.63L39.00 108.63L38.95 108.58Q39.87 105.80 39.92 101.49L39.84 101.40L39.81 101.38Q38.27 103.64 36.03 104.88L35.98 104.83L36.01 104.86Q33.72 106.04 31.48 106.04L31.55 106.11L31.52 106.08Q26.83 106.03 24.08 103.29L24.08 103.29L24.02 103.23Q21.34 100.55 21.34 95.00L21.42 95.08L21.35 95.02Q21.23 92.32 22.07 90.22L22.09 90.24L22.25 90.40Q23.08 88.29 24.51 86.78L24.36 86.63L24.50 86.77Q25.95 85.28 27.88 84.44L27.84 84.40L27.81 84.37Q29.80 83.59 31.93 83.59L31.78 83.44L31.86 83.52Q34.54 83.56 36.81 84.63L36.80 84.62L36.72 84.54Q39.00 85.61 40.65 87.77L40.63 87.75L40.72 87.84Q42.31 89.94 43.24 93.16L43.33 93.25L43.15 93.07Q44.24 96.45 44.24 100.76L44.19 100.72L44.26 100.79Q44.25 106.15 43.13 109.93L42.97 109.77L43.06 109.86Q41.95 113.65 40.05 116.03L39.95 115.94L39.97 115.95Q38.09 118.37 35.66 119.46L35.65 119.45L35.63 119.43Q33.16 120.49 30.47 120.49L30.64 120.66L30.57 120.59Q27.69 120.56 25.53 119.50L25.46 119.42L25.47 119.43Q23.31 118.37 21.85 116.74L21.95 116.83Z"/><path d="M7 150 C85 3,113 64,196 87" stroke="#b7e589" fill="none"/><path d="M17 171 C110 40,106 99,185 197" stroke="#5175e0" fill="none"/><path fill="#6dedcd" d="M166.04 108.77L162.14 108.90L162.04 108.80Q161.72 106.63 162.20 104.87L162.13 104.80L162.17 104.84Q162.65 103.08 163.49 101.60L163.54 101.65L163.55 101.66Q164.41 100.20 165.50 98.91L165.46 98.86L165.42 98.82Q166.53 97.56 167.48 96.30L167.41 96.22L167.59 96.40Q168.54 95.14 169.18 93.85L169.01 93.68L169.14 93.81Q169.76 92.50 169.76 90.99L169.64 90.87L169.72 90.94Q169.78 88.77 168.41 87.17L168.42 87.18L168.44 87.20Q166.94 85.48 164.25 85.48L164.31 85.54L164.28 85.50Q162.49 85.56 160.84 86.43L160.78 86.37L160.71 86.31Q159.08 87.19 157.79 88.70L157.88 88.79L155.15 86.29L155.18 86.31Q156.95 84.28 159.25 82.97L159.35 83.07L159.22 82.93Q161.58 81.68 164.60 81.68L164.70 81.78L164.67 81.75Q168.97 81.68 171.57 84.06L171.54 84.03L171.59 84.08Q174.18 86.44 174.18 90.64L174.26 90.73L174.25 90.71Q174.21 92.52 173.54 94.03L173.47 93.97L173.45 93.95Q172.92 95.60 171.94 96.94L171.91 96.91L171.87 96.87Q170.91 98.24 169.82 99.56L169.78 99.51L169.84 99.58Q168.72 100.86 167.79 102.26L167.74 102.20L167.80 102.27Q166.78 103.57 166.28 105.17L166.44 105.33L166.27 105.16Q165.82 106.81 166.04 108.77L166.15 108.87ZM160.87 117.09L160.83 117.06L160.79 117.02Q160.85 115.45 161.80 114.47L161.84 114.50L161.82 114.49Q162.83 113.57 164.23 113.57L164.26 113.60L164.15 113.48Q165.65 113.58 166.63 114.56L166.49 114.43L166.56 114.50Q167.62 115.55 167.62 117.18L167.61 117.17L167.59 117.15Q167.50 118.57 166.52 119.55L166.53 119.56L166.49 119.52Q165.60 120.59 164.20 120.59L164.29 120.68L164.12 120.51Q162.87 120.67 161.92 119.69L161.78 119.54L161.92 119.68Q160.80 118.54 160.80 117.02Z"/><path fill="#7ce396" d="M59.54 107.59L59.54 104.07L72.37 104.02L72.48 107.65L59.54 107.59Z"/></svg>',
  validUntil: '2023-06-13',
  __typename: 'Challenge'
} as Challenge

const registerVariables = {
  name: 'Bar',
  email: 'foobar@email.com',
  challengeAnswer: {
    challengeSolution: '1',
    challengeID: challenge.challengeID
  },
  firstName: 'Foo',
  address: {streetAddress: 'Musterstrasse 1', zipCode: '8047', city: 'ZÃ¼rich', country: 'Schweiz'},
  password: '12345678'
}

export const Filled: StoryObj = {
  render: function Render(args) {
    const {user} = useUser()

    return (
      <>
        {user && <div>Logged in as {user?.firstName}</div>}
        <RegistrationFormContainer {...args} />
      </>
    )
  },
  args: {
    onRegister: action('onRegister'),
    onChallengeQuery: action('onChallengeQuery')
  },
  play: async ctx => {
    const canvas = within(ctx.canvasElement)
    await waitFor(() => canvas.getByLabelText('Captcha'))

    await registrationFormStories.Filled.play?.(ctx)
  },
  parameters: {
    apolloClient: {
      mocks: [
        {
          request: {
            query: ChallengeDocument
          },
          result: {
            data: {challenge}
          }
        },
        {
          request: {
            query: RegisterDocument,
            variables: registerVariables
          },
          result: {
            data: {
              registerMember: {
                session: {
                  createdAt: new Date(),
                  expiresAt: new Date(),
                  token: '1234-1234'
                },
                user: {
                  id: '1234-1234',
                  firstName: 'Foo',
                  name: 'Bar',
                  email: 'foobar@example.com',
                  oauth2Accounts: [],
                  paymentProviderCustomers: [],
                  properties: []
                }
              }
            }
          }
        }
      ]
    }
  }
}

export const WithChallengeError: StoryObj = {
  args: {
    onRegister: action('onRegister'),
    onChallengeQuery: action('onChallengeQuery')
  },
  parameters: {
    apolloClient: {
      mocks: [
        {
          request: {
            query: ChallengeDocument
          },
          result: {
            errors: [new ApolloError({errorMessage: 'Something went wrong.'})]
          }
        },
        {
          request: {
            query: RegisterDocument
          },
          result: {
            data: {}
          }
        }
      ]
    }
  }
}

export const WithRegisterError: StoryObj = {
  args: {
    onRegister: action('onRegister'),
    onChallengeQuery: action('onChallengeQuery')
  },
  play: Filled.play,
  parameters: {
    apolloClient: {
      mocks: [
        {
          request: {
            query: ChallengeDocument
          },
          result: {
            data: {challenge}
          }
        },
        {
          request: {
            query: RegisterDocument,
            variables: registerVariables
          },
          result: {
            errors: [new ApolloError({errorMessage: 'Email already in use.'})]
          }
        },
        {
          request: {
            query: ChallengeDocument
          },
          result: {
            data: {
              challenge: {
                ...challenge,
                challenge: `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0,0,200,200"><rect width="100%" height="100%" fill="#ffffff"/><path fill="#7de2af" d="M75.33 119.88L75.33 116.06L83.60 116.16L83.62 89.86L76.98 89.72L77.08 86.85L76.96 86.73Q79.46 86.31 81.28 85.67L81.30 85.69L81.30 85.69Q83.19 85.12 84.64 84.22L84.53 84.11L88.13 84.17L88.22 116.19L95.53 116.11L95.60 119.98L75.31 119.86Z"/><path d="M4 3 C85 105,91 137,182 27" stroke="#dfdf3e" fill="none"/><path d="M17 120 C120 43,121 144,194 20" stroke="#5757da" fill="none"/><path fill="#8cdf70" d="M113.23 120.64L113.21 120.62L113.27 120.68Q107.73 120.57 104.71 115.76L104.64 115.69L104.73 115.78Q101.61 110.87 101.61 101.85L101.63 101.87L101.70 101.94Q101.64 92.86 104.66 88.16L104.81 88.30L104.68 88.18Q107.81 83.58 113.24 83.58L113.27 83.60L113.14 83.48Q118.52 83.49 121.55 88.19L121.53 88.17L121.51 88.15Q124.64 92.96 124.64 101.97L124.61 101.94L124.51 101.85Q124.60 110.95 121.58 115.77L121.47 115.66L121.56 115.75Q118.62 120.66 113.25 120.66ZM113.08 116.80L113.17 116.88L113.23 116.94Q114.77 116.91 116.03 116.05L116.08 116.09L115.92 115.94Q117.27 115.16 118.20 113.34L118.25 113.40L118.21 113.36Q119.16 111.56 119.66 108.73L119.69 108.75L119.63 108.70Q120.17 105.91 120.17 101.99L120.08 101.90L120.15 101.97Q120.18 98.07 119.67 95.27L119.59 95.19L119.65 95.25Q119.18 92.48 118.25 90.72L118.11 90.58L118.12 90.59Q117.28 88.90 116.02 88.06L116.02 88.06L116.04 88.09Q114.64 87.11 113.07 87.11L113.25 87.28L113.12 87.15Q111.56 87.16 110.27 88.00L110.35 88.08L110.41 88.14Q109.07 88.92 108.14 90.69L108.17 90.72L108.07 90.62Q107.24 92.47 106.74 95.27L106.60 95.13L106.65 95.19Q106.17 98.01 106.17 101.93L106.24 102.00L106.18 101.95Q106.16 109.76 108.09 113.31L108.11 113.33L108.09 113.31Q110.07 116.92 113.21 116.92Z"/><path d="M6 44 C99 155,100 189,180 160" stroke="#76dfaa" fill="none"/><path d="M20 44 C98 157,81 46,184 18" stroke="#8be8a2" fill="none"/><path fill="#68a5e3" d="M129.42 97.17L129.37 93.66L153.36 93.62L153.40 97.13L129.48 97.24ZM129.48 109.16L129.49 105.70L153.40 105.59L153.36 109.02L129.49 109.18Z"/><path fill="#aadf75" d="M54.81 114.14L54.73 103.14L44.63 103.23L44.51 99.65L54.75 99.69L54.76 88.78L58.34 88.72L58.40 99.70L68.68 99.79L68.53 103.11L58.43 103.20L58.34 114.03L54.81 114.14Z"/><path d="M18 89 C102 139,112 11,183 24" stroke="#88f1f1" fill="none"/><path fill="#56eb56" d="M170.88 108.90L166.74 108.79L166.76 108.80Q166.34 106.54 166.82 104.78L166.91 104.87L166.99 104.94Q167.30 103.02 168.14 101.54L168.14 101.53L168.29 101.68Q169.10 100.17 170.19 98.88L170.26 98.95L170.21 98.90Q171.29 97.60 172.24 96.34L172.25 96.35L172.30 96.40Q173.17 95.06 173.82 93.77L173.90 93.85L173.74 93.70Q174.39 92.41 174.39 90.89L174.52 91.03L174.48 90.99Q174.38 88.65 173.01 87.05L173.10 87.14L173.16 87.20Q171.67 85.49 168.98 85.49L168.94 85.45L169.09 85.60Q167.17 85.53 165.52 86.40L165.46 86.34L165.55 86.43Q163.95 87.35 162.67 88.86L162.53 88.72L159.87 86.29L159.99 86.42Q161.78 84.39 164.07 83.08L164.03 83.03L164.00 83.00Q166.33 81.72 169.35 81.72L169.25 81.62L169.40 81.76Q173.62 81.62 176.23 84.00L176.39 84.16L176.35 84.12Q178.97 86.52 178.97 90.72L178.96 90.71L178.94 90.69Q178.97 92.57 178.30 94.08L178.26 94.05L178.22 94.01Q177.54 95.50 176.56 96.85L176.65 96.94L176.61 96.90Q175.55 98.17 174.46 99.48L174.57 99.59L174.52 99.55Q173.49 100.92 172.57 102.32L172.43 102.19L172.51 102.27Q171.51 103.58 171.00 105.18L171.16 105.34L171.17 105.35Q170.49 106.76 170.71 108.72L170.82 108.83ZM165.53 117.04L165.65 117.16L165.51 117.02Q165.60 115.49 166.55 114.51L166.57 114.52L166.62 114.57Q167.49 113.51 168.89 113.51L168.95 113.57L168.91 113.53Q170.28 113.50 171.26 114.48L171.36 114.58L171.29 114.51Q172.26 115.48 172.26 117.10L172.36 117.20L172.35 117.19Q172.30 118.66 171.32 119.64L171.29 119.61L171.37 119.69Q170.29 120.57 168.89 120.57L168.89 120.57L168.93 120.60Q167.50 120.58 166.55 119.60L166.64 119.69L166.46 119.51Q165.58 118.60 165.58 117.08Z"/><path fill="#bce594" d="M15.91 115.62L18.08 112.42L18.22 112.56Q19.87 114.27 22.03 115.55L22.05 115.57L21.97 115.50Q24.07 116.73 27.27 116.73L27.27 116.74L27.29 116.76Q30.54 116.76 32.61 114.99L32.61 114.99L32.68 115.07Q34.69 113.23 34.69 110.21L34.69 110.21L34.70 110.22Q34.69 108.65 34.10 107.33L34.10 107.32L34.16 107.38Q33.56 106.05 32.21 105.10L32.23 105.12L32.08 104.97Q30.80 104.08 28.62 103.58L28.57 103.54L28.61 103.57Q26.43 103.07 23.24 103.07L23.24 103.07L23.23 99.53L23.24 99.55Q26.13 99.58 28.07 99.08L28.07 99.08L28.03 99.04Q29.95 98.53 31.15 97.63L31.19 97.67L31.10 97.58Q32.37 96.75 32.87 95.51L32.84 95.48L32.83 95.48Q33.43 94.34 33.43 92.94L33.41 92.91L33.49 92.99Q33.43 90.30 31.78 88.79L31.79 88.81L31.73 88.74Q30.01 87.16 27.15 87.16L27.23 87.24L27.17 87.18Q25.00 87.25 23.13 88.26L23.14 88.27L23.15 88.29Q21.34 89.36 19.72 90.98L19.71 90.97L17.08 87.90L17.11 87.93Q19.34 86.12 21.83 84.86L21.73 84.76L21.71 84.74Q24.29 83.57 27.48 83.57L27.32 83.41L27.49 83.58Q29.75 83.49 31.71 84.10L31.82 84.21L31.68 84.07Q33.72 84.77 35.15 85.92L35.08 85.85L35.07 85.84Q36.58 87.07 37.37 88.75L37.25 88.64L37.36 88.75Q38.18 90.47 38.18 92.65L38.20 92.67L38.07 92.54Q38.11 95.83 36.32 97.90L36.37 97.94L36.27 97.85Q34.55 99.99 31.63 101.11L31.52 101.00L31.72 101.41L31.58 101.28Q33.16 101.63 34.56 102.38L34.69 102.51L34.70 102.52Q36.00 103.18 37.06 104.33L37.08 104.34L37.19 104.45Q38.22 105.57 38.81 107.08L38.72 106.99L38.67 106.94Q39.29 108.48 39.29 110.33L39.43 110.48L39.41 110.45Q39.39 112.78 38.46 114.69L38.43 114.65L38.36 114.58Q37.52 116.57 35.92 117.88L35.90 117.86L35.90 117.87Q34.22 119.09 32.09 119.79L32.10 119.80L32.19 119.89Q30.04 120.57 27.58 120.57L27.51 120.50L27.67 120.67Q25.51 120.63 23.74 120.21L23.71 120.18L23.76 120.22Q21.95 119.76 20.49 119.06L20.55 119.12L20.47 119.04Q19.06 118.38 17.91 117.49L17.94 117.51L17.90 117.48Q16.67 116.50 15.78 115.49L15.80 115.51Z"/></svg>`
              }
            }
          }
        }
      ]
    }
  }
}

export const WithClassName: StoryObj = {
  args: {
    onRegister: action('onRegister'),
    onChallengeQuery: action('onChallengeQuery'),
    className: 'extra-classname'
  },
  parameters: {
    apolloClient: {
      mocks: [
        {
          request: {
            query: ChallengeDocument
          },
          result: {
            data: {challenge}
          }
        }
      ]
    }
  }
}

export const WithEmotion: StoryObj = {
  args: {
    onRegister: action('onRegister'),
    onChallengeQuery: action('onChallengeQuery'),
    css: css`
      background-color: #eee;
    `
  },
  parameters: {
    apolloClient: {
      mocks: [
        {
          request: {
            query: ChallengeDocument
          },
          result: {
            data: {challenge}
          }
        }
      ]
    }
  }
}
